Description: fix denial of service via use after free
Origin: upstream, https://git.openssl.org/gitweb/?p=openssl.git;a=commitdiff;h=94d1f4b
Bug: https://rt.openssl.org/Ticket/Display.html?id=3265&user=guest&pass=guest
Bug: https://rt.openssl.org/Ticket/Display.html?id=2167&user=guest&pass=guest

Index: openssl-1.0.1f/ssl/s3_pkt.c
===================================================================
--- openssl-1.0.1f.orig/ssl/s3_pkt.c	2014-05-02 15:00:18.948467658 -0400
+++ openssl-1.0.1f/ssl/s3_pkt.c	2014-05-02 15:00:18.940467658 -0400
@@ -1055,7 +1055,7 @@
 				{
 				s->rstate=SSL_ST_READ_HEADER;
 				rr->off=0;
-				if (s->mode & SSL_MODE_RELEASE_BUFFERS)
+				if (s->mode & SSL_MODE_RELEASE_BUFFERS && s->s3->rbuf.left == 0)
 					ssl3_release_read_buffer(s);
 				}
 			}
