Description: fix double free when processing DTLS packets
Origin: upstream, https://git.openssl.org/gitweb/?p=openssl.git;a=commit;h=2172d4f63c61922487008f42511cc6bdae9b47a0
Origin: upstream, https://git.openssl.org/gitweb/?p=openssl.git;a=commit;h=e7b9d9be48cdc598a46c8e1536035ed29a9af254

Index: openssl-1.0.1f/ssl/d1_both.c
===================================================================
--- openssl-1.0.1f.orig/ssl/d1_both.c	2014-08-07 07:36:13.000000000 -0400
+++ openssl-1.0.1f/ssl/d1_both.c	2014-08-07 07:58:15.074807054 -0400
@@ -639,7 +639,8 @@
 
 
 	/* If message is already reassembled, this must be a
-	 * retransmit and can be dropped.
+	 * retransmit and can be dropped. In this case item != NULL and so frag
+	 * does not need to be freed.
 	 */
 	if (frag->reassembly == NULL)
 		{
@@ -693,8 +694,7 @@
 	return DTLS1_HM_FRAGMENT_RETRY;
 
 err:
-	if (frag != NULL) dtls1_hm_fragment_free(frag);
-	if (item != NULL) OPENSSL_free(item);
+	if (frag != NULL && item == NULL) dtls1_hm_fragment_free(frag);
 	*ok = 0;
 	return i;
 	}
@@ -778,8 +778,7 @@
 	return DTLS1_HM_FRAGMENT_RETRY;
 
 err:
-	if ( frag != NULL) dtls1_hm_fragment_free(frag);
-	if ( item != NULL) OPENSSL_free(item);
+	if (frag != NULL && item == NULL) dtls1_hm_fragment_free(frag);
 	*ok = 0;
 	return i;
 	}
