From 8d7aab986b499f34d9e1bc58fbfd77f05c38116e Mon Sep 17 00:00:00 2001
From: "Dr. Stephen Henson" <steve@openssl.org>
Date: Sat, 3 Jan 2015 00:45:13 +0000
Subject: [PATCH] Fix crash in dtls1_get_record whilst in the listen state
 where you get two separate reads performed - one for the
 header and one for the body of the handshake record.

CVE-2014-3571

Reviewed-by: Matt Caswell <matt@openssl.org>
---
 ssl/d1_pkt.c |    2 --
 ssl/s3_pkt.c |    2 ++
 2 files changed, 2 insertions(+), 2 deletions(-)

Index: openssl-1.0.1f/ssl/d1_pkt.c
===================================================================
--- openssl-1.0.1f.orig/ssl/d1_pkt.c	2015-01-09 07:55:51.175548258 -0500
+++ openssl-1.0.1f/ssl/d1_pkt.c	2015-01-09 07:55:51.171548232 -0500
@@ -641,8 +641,6 @@
 		/* now s->packet_length == DTLS1_RT_HEADER_LENGTH */
 		i=rr->length;
 		n=ssl3_read_n(s,i,i,1);
-		if (n <= 0) return(n); /* error or non-blocking io */
-
 		/* this packet contained a partial record, dump it */
 		if ( n != i)
 			{
Index: openssl-1.0.1f/ssl/s3_pkt.c
===================================================================
--- openssl-1.0.1f.orig/ssl/s3_pkt.c	2015-01-09 07:55:51.175548258 -0500
+++ openssl-1.0.1f/ssl/s3_pkt.c	2015-01-09 07:55:51.175548258 -0500
@@ -182,6 +182,8 @@
 	 * at once (as long as it fits into the buffer). */
 	if (SSL_version(s) == DTLS1_VERSION || SSL_version(s) == DTLS1_BAD_VER)
 		{
+		if (left == 0 && extend)
+			return 0;
 		if (left > 0 && n > left)
 			n = left;
 		}
