From 45fe66b8ba026186aa5d8ef1e0e6010ea74d5c0b Mon Sep 17 00:00:00 2001
From: Matt Caswell <matt@openssl.org>
Date: Sat, 3 Jan 2015 00:54:35 +0000
Subject: [PATCH] Follow on from CVE-2014-3571. This fixes the code that was
 the original source of the crash due to p being NULL.
 Steve's fix prevents this situation from occuring - however
 this is by no means obvious by looking at the code for
 dtls1_get_record. This fix just makes things look a bit
 more sane.

Reviewed-by: Dr Steve Henson <steve@openssl.org>
---
 ssl/d1_pkt.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

Index: openssl-1.0.1f/ssl/d1_pkt.c
===================================================================
--- openssl-1.0.1f.orig/ssl/d1_pkt.c	2015-01-09 07:56:03.571632281 -0500
+++ openssl-1.0.1f/ssl/d1_pkt.c	2015-01-09 07:56:03.567632253 -0500
@@ -675,7 +675,8 @@
 		 * would be dropped unnecessarily.
 		 */
 		if (!(s->d1->listen && rr->type == SSL3_RT_HANDSHAKE &&
-		    *p == SSL3_MT_CLIENT_HELLO) &&
+		    s->packet_length > DTLS1_RT_HEADER_LENGTH &&
+		    s->packet[DTLS1_RT_HEADER_LENGTH] == SSL3_MT_CLIENT_HELLO) &&
 		    !dtls1_record_replay_check(s, bitmap))
 			{
 			rr->length = 0;
