Description: fix crash with SRP ciphersuite in Server Hello message
Origin: upstream, https://git.openssl.org/gitweb/?p=openssl.git;a=commit;h=18c7f2fce8a82b13506cac7ca69fc333baf76408
Origin: upstream, https://git.openssl.org/gitweb/?p=openssl.git;a=commit;h=83764a989dcc87fbea337da5f8f86806fe767b7e

Index: openssl-1.0.1f/ssl/s3_clnt.c
===================================================================
--- openssl-1.0.1f.orig/ssl/s3_clnt.c	2014-08-07 08:15:00.794833987 -0400
+++ openssl-1.0.1f/ssl/s3_clnt.c	2014-08-07 08:15:00.790833986 -0400
@@ -954,6 +954,15 @@
 		SSLerr(SSL_F_SSL3_GET_SERVER_HELLO,SSL_R_WRONG_CIPHER_RETURNED);
 		goto f_err;
 		}
+#ifndef OPENSSL_NO_SRP
+	if (((c->algorithm_mkey & SSL_kSRP) || (c->algorithm_auth & SSL_aSRP)) &&
+		    !(s->srp_ctx.srp_Mask & SSL_kSRP))
+		{
+		al=SSL_AD_ILLEGAL_PARAMETER;
+		SSLerr(SSL_F_SSL3_GET_SERVER_HELLO,SSL_R_WRONG_CIPHER_RETURNED);
+		goto f_err;
+		}
+#endif /* OPENSSL_NO_SRP */
 	p+=ssl_put_cipher_by_char(s,NULL,NULL);
 
 	sk=ssl_get_ciphers_by_id(s);
Index: openssl-1.0.1f/ssl/ssl_lib.c
===================================================================
--- openssl-1.0.1f.orig/ssl/ssl_lib.c	2014-08-07 08:15:00.794833987 -0400
+++ openssl-1.0.1f/ssl/ssl_lib.c	2014-08-07 08:15:00.794833987 -0400
@@ -1402,6 +1402,11 @@
 		    s->psk_client_callback == NULL)
 			continue;
 #endif /* OPENSSL_NO_PSK */
+#ifndef OPENSSL_NO_SRP
+		if (((c->algorithm_mkey & SSL_kSRP) || (c->algorithm_auth & SSL_aSRP)) &&
+		    !(s->srp_ctx.srp_Mask & SSL_kSRP))
+		    continue;
+#endif /* OPENSSL_NO_SRP */
 		j = put_cb ? put_cb(c,p) : ssl_put_cipher_by_char(s,c,p);
 		p+=j;
 		}
Index: openssl-1.0.1f/ssl/s3_lib.c
===================================================================
--- openssl-1.0.1f.orig/ssl/s3_lib.c	2014-01-06 08:47:42.000000000 -0500
+++ openssl-1.0.1f/ssl/s3_lib.c	2014-08-07 09:06:13.402916268 -0400
@@ -2426,7 +2426,7 @@
 	TLS1_TXT_SRP_SHA_WITH_3DES_EDE_CBC_SHA,
 	TLS1_CK_SRP_SHA_WITH_3DES_EDE_CBC_SHA,
 	SSL_kSRP,
-	SSL_aNULL,
+	SSL_aSRP,
 	SSL_3DES,
 	SSL_SHA1,
 	SSL_TLSV1,
@@ -2474,7 +2474,7 @@
 	TLS1_TXT_SRP_SHA_WITH_AES_128_CBC_SHA,
 	TLS1_CK_SRP_SHA_WITH_AES_128_CBC_SHA,
 	SSL_kSRP,
-	SSL_aNULL,
+	SSL_aSRP,
 	SSL_AES128,
 	SSL_SHA1,
 	SSL_TLSV1,
@@ -2522,7 +2522,7 @@
 	TLS1_TXT_SRP_SHA_WITH_AES_256_CBC_SHA,
 	TLS1_CK_SRP_SHA_WITH_AES_256_CBC_SHA,
 	SSL_kSRP,
-	SSL_aNULL,
+	SSL_aSRP,
 	SSL_AES256,
 	SSL_SHA1,
 	SSL_TLSV1,
Index: openssl-1.0.1f/ssl/ssl.h
===================================================================
--- openssl-1.0.1f.orig/ssl/ssl.h	2014-01-06 08:47:42.000000000 -0500
+++ openssl-1.0.1f/ssl/ssl.h	2014-08-07 09:06:13.406916269 -0400
@@ -264,6 +264,7 @@
 #define SSL_TXT_aGOST94	"aGOST94"
 #define SSL_TXT_aGOST01 "aGOST01"
 #define SSL_TXT_aGOST  "aGOST"
+#define SSL_TXT_aSRP            "aSRP"
 
 #define	SSL_TXT_DSS		"DSS"
 #define SSL_TXT_DH		"DH"
Index: openssl-1.0.1f/ssl/ssl_ciph.c
===================================================================
--- openssl-1.0.1f.orig/ssl/ssl_ciph.c	2014-01-06 08:47:42.000000000 -0500
+++ openssl-1.0.1f/ssl/ssl_ciph.c	2014-08-07 09:06:13.406916269 -0400
@@ -270,6 +270,7 @@
 	{0,SSL_TXT_aGOST94,0,0,SSL_aGOST94,0,0,0,0,0,0,0},
 	{0,SSL_TXT_aGOST01,0,0,SSL_aGOST01,0,0,0,0,0,0,0},
 	{0,SSL_TXT_aGOST,0,0,SSL_aGOST94|SSL_aGOST01,0,0,0,0,0,0,0},
+	{0,SSL_TXT_aSRP,0,    0,SSL_aSRP,  0,0,0,0,0,0,0},
 
 	/* aliases combining key exchange and server authentication */
 	{0,SSL_TXT_EDH,0,     SSL_kEDH,~SSL_aNULL,0,0,0,0,0,0,0},
@@ -1628,6 +1629,9 @@
 	case SSL_aPSK:
 		au="PSK";
 		break;
+	case SSL_aSRP:
+		au="SRP";
+		break;
 	default:
 		au="unknown";
 		break;
Index: openssl-1.0.1f/ssl/ssl_locl.h
===================================================================
--- openssl-1.0.1f.orig/ssl/ssl_locl.h	2014-01-06 08:47:42.000000000 -0500
+++ openssl-1.0.1f/ssl/ssl_locl.h	2014-08-07 09:06:13.406916269 -0400
@@ -311,6 +311,7 @@
 #define SSL_aPSK                0x00000080L /* PSK auth */
 #define SSL_aGOST94				0x00000100L /* GOST R 34.10-94 signature auth */
 #define SSL_aGOST01 			0x00000200L /* GOST R 34.10-2001 signature auth */
+#define SSL_aSRP 		0x00000400L /* SRP auth */
 
 
 /* Bits for algorithm_enc (symmetric encryption) */
