Description: fix denial of service via missing EnvelopedContent
Origin: based on patch by Emilia KÃ¤sper

Index: openssl-1.0.1f/crypto/pkcs7/pk7_doit.c
===================================================================
--- openssl-1.0.1f.orig/crypto/pkcs7/pk7_doit.c	2015-06-08 09:06:32.056325940 -0400
+++ openssl-1.0.1f/crypto/pkcs7/pk7_doit.c	2015-06-08 09:09:19.970150117 -0400
@@ -468,12 +468,19 @@
 	switch (i)
 		{
 	case NID_pkcs7_signed:
+		/*
+		 * p7->d.sign->contents is a PKCS7 structure consisting of a contentType
+		 * field and optional content.
+		 * data_body is NULL if that structure has no (=detached) content
+		 * or if the contentType is wrong (i.e., not "data").
+		 */
 		data_body=PKCS7_get_octet_string(p7->d.sign->contents);
 		md_sk=p7->d.sign->md_algs;
 		break;
 	case NID_pkcs7_signedAndEnveloped:
 		rsk=p7->d.signed_and_enveloped->recipientinfo;
 		md_sk=p7->d.signed_and_enveloped->md_algs;
+		/* data_body is NULL if the optional EncryptedContent is missing. */
 		data_body=p7->d.signed_and_enveloped->enc_data->enc_data;
 		enc_alg=p7->d.signed_and_enveloped->enc_data->algorithm;
 		evp_cipher=EVP_get_cipherbyobj(enc_alg->algorithm);
@@ -486,6 +493,7 @@
 	case NID_pkcs7_enveloped:
 		rsk=p7->d.enveloped->recipientinfo;
 		enc_alg=p7->d.enveloped->enc_data->algorithm;
+		/* data_body is NULL if the optional EncryptedContent is missing. */
 		data_body=p7->d.enveloped->enc_data->enc_data;
 		evp_cipher=EVP_get_cipherbyobj(enc_alg->algorithm);
 		if (evp_cipher == NULL)
@@ -499,6 +507,13 @@
 	        goto err;
 		}
 
+	/* Detached content must be supplied via in_bio instead. */
+	if (data_body == NULL && in_bio == NULL)
+		{
+		PKCS7err(PKCS7_F_PKCS7_DATADECODE, PKCS7_R_NO_CONTENT);
+		goto err;
+		}
+
 	/* We will be checking the signature */
 	if (md_sk != NULL)
 		{
@@ -655,7 +670,7 @@
 		}
 
 #if 1
-	if (PKCS7_is_detached(p7) || (in_bio != NULL))
+	if (in_bio != NULL)
 		{
 		bio=in_bio;
 		}
