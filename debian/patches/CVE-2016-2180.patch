Backport of:

From 6adf409c7432b90c06d9890787fe56c48f2a16e7 Mon Sep 17 00:00:00 2001
From: "Dr. Stephen Henson" <steve@openssl.org>
Date: Thu, 21 Jul 2016 15:24:16 +0100
Subject: [PATCH] Fix OOB read in TS_OBJ_print_bio().

TS_OBJ_print_bio() misuses OBJ_txt2obj: it should print the result
as a null terminated buffer. The length value returned is the total
length the complete text reprsentation would need not the amount of
data written.

CVE-2016-2180

Thanks to Shi Lei for reporting this bug.

Reviewed-by: Matt Caswell <matt@openssl.org>
(cherry picked from commit 0ed26acce328ec16a3aa635f1ca37365e8c7403a)
---
 crypto/ts/ts_lib.c | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

Index: openssl-1.0.1f/crypto/ts/ts_lib.c
===================================================================
--- openssl-1.0.1f.orig/crypto/ts/ts_lib.c	2016-09-22 09:18:05.586668403 -0400
+++ openssl-1.0.1f/crypto/ts/ts_lib.c	2016-09-22 09:18:37.779060859 -0400
@@ -90,9 +90,8 @@
 	{
 	char obj_txt[128];
 
-	int len = OBJ_obj2txt(obj_txt, sizeof(obj_txt), obj, 0);
-	BIO_write(bio, obj_txt, len);
-	BIO_write(bio, "\n", 1);
+	OBJ_obj2txt(obj_txt, sizeof(obj_txt), obj, 0);
+	BIO_printf(bio, "%s\n", obj_txt);
 
 	return 1;
 	}
