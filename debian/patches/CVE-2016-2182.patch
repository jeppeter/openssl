Backport of:

From 28a89639da50b1caed4ff3015508f23173bf3e49 Mon Sep 17 00:00:00 2001
From: "Dr. Stephen Henson" <steve@openssl.org>
Date: Fri, 5 Aug 2016 14:26:03 +0100
Subject: [PATCH] Check for errors in BN_bn2dec()

If an oversize BIGNUM is presented to BN_bn2dec() it can cause
BN_div_word() to fail and not reduce the value of 't' resulting
in OOB writes to the bn_data buffer and eventually crashing.

Fix by checking return value of BN_div_word() and checking writes
don't overflow buffer.

Thanks to Shi Lei for reporting this bug.

CVE-2016-2182

Reviewed-by: Tim Hudson <tjh@openssl.org>
(cherry picked from commit 07bed46f332fce8c1d157689a2cdf915a982ae34)

Conflicts:
	crypto/bn/bn_print.c
---
 crypto/bn/bn_print.c | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

Index: openssl-1.0.1f/crypto/bn/bn_print.c
===================================================================
--- openssl-1.0.1f.orig/crypto/bn/bn_print.c	2016-09-22 09:32:18.388936033 -0400
+++ openssl-1.0.1f/crypto/bn/bn_print.c	2016-09-22 09:33:51.318088684 -0400
@@ -108,6 +108,7 @@
 	char *p;
 	BIGNUM *t=NULL;
 	BN_ULONG *bn_data=NULL,*lp;
+	int bn_data_num;
 
 	/* get an upper bound for the length of the decimal integer
 	 * num <= (BN_num_bits(a) + 1) * log(2)
@@ -116,8 +117,9 @@
 	 */
 	i=BN_num_bits(a)*3;
 	num=(i/10+i/1000+1)+1;
-	bn_data=(BN_ULONG *)OPENSSL_malloc((num/BN_DEC_NUM+1)*sizeof(BN_ULONG));
-	buf=(char *)OPENSSL_malloc(num+3);
+	bn_data_num = num / BN_DEC_NUM + 1;
+	bn_data = OPENSSL_malloc(bn_data_num * sizeof(BN_ULONG));
+	buf = OPENSSL_malloc(num + 3);
 	if ((buf == NULL) || (bn_data == NULL))
 		{
 		BNerr(BN_F_BN_BN2DEC,ERR_R_MALLOC_FAILURE);
@@ -142,7 +144,11 @@
 		while (!BN_is_zero(t))
 			{
 			*lp=BN_div_word(t,BN_DEC_CONV);
+			if (*lp == (BN_ULONG)-1)
+				goto err;
 			lp++;
+			if (lp - bn_data >= bn_data_num)
+				goto err;
 			}
 		lp--;
 		/* We now have a series of blocks, BN_DEC_NUM chars
