Backport of:

From 52e623c4cb06fffa9d5e75c60b34b4bc130b12e9 Mon Sep 17 00:00:00 2001
From: "Dr. Stephen Henson" <steve@openssl.org>
Date: Sat, 17 Sep 2016 12:36:58 +0100
Subject: [PATCH] Fix small OOB reads.

In ssl3_get_client_certificate, ssl3_get_server_certificate and
ssl3_get_certificate_request check we have enough room
before reading a length.

Thanks to Shi Lei (Gear Team, Qihoo 360 Inc.) for reporting these bugs.

CVE-2016-6306

Reviewed-by: Richard Levitte <levitte@openssl.org>
Reviewed-by: Matt Caswell <matt@openssl.org>
(cherry picked from commit ff553f837172ecb2b5c8eca257ec3c5619a4b299)
---
 ssl/s3_clnt.c | 11 +++++++++++
 ssl/s3_srvr.c |  6 ++++++
 2 files changed, 17 insertions(+)

Index: openssl-1.0.1f/ssl/s3_clnt.c
===================================================================
--- openssl-1.0.1f.orig/ssl/s3_clnt.c	2016-09-22 09:44:20.693840615 -0400
+++ openssl-1.0.1f/ssl/s3_clnt.c	2016-09-22 09:46:26.871384756 -0400
@@ -1136,6 +1136,12 @@
 		}
 	for (nc=0; nc<llen; )
 		{
+		if (nc + 3 > llen)
+			{
+			al = SSL_AD_DECODE_ERROR;
+			SSLerr(SSL_F_SSL3_GET_SERVER_CERTIFICATE,SSL_R_CERT_LENGTH_MISMATCH);
+			goto f_err;
+			}
 		n2l3(p,l);
 		if ((l+nc+3) > llen)
 			{
@@ -1986,6 +1992,12 @@
 
 	for (nc=0; nc<llen; )
 		{
+		if (nc + 2 > llen)
+			{
+			ssl3_send_alert(s, SSL3_AL_FATAL, SSL_AD_DECODE_ERROR);
+			SSLerr(SSL_F_SSL3_GET_CERTIFICATE_REQUEST, SSL_R_CA_DN_TOO_LONG);
+			goto err;
+			}
 		n2s(p,l);
 		if ((l+nc+2) > llen)
 			{
Index: openssl-1.0.1f/ssl/s3_srvr.c
===================================================================
--- openssl-1.0.1f.orig/ssl/s3_srvr.c	2016-09-22 09:44:20.693840615 -0400
+++ openssl-1.0.1f/ssl/s3_srvr.c	2016-09-22 09:47:25.964106925 -0400
@@ -3216,6 +3216,12 @@
 		}
 	for (nc=0; nc<llen; )
 		{
+		if (nc + 3 > llen)
+			{
+			al = SSL_AD_DECODE_ERROR;
+			SSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,SSL_R_CERT_LENGTH_MISMATCH);
+			goto f_err;
+			}
 		n2l3(p,l);
 		if ((l+nc+3) > llen)
 			{
